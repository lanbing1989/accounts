<?php
// install.php —— 高端会计系统数据库一键初始化，支持多账套/多制度/账套个性化科目（标准科目已完整内置）

if (!is_dir('db')) mkdir('db');
$db_file = 'db/accounting.db';
if (file_exists($db_file)) {
    echo "<h3>数据库文件已存在：{$db_file}</h3>";
    echo "<a href='index.php'>进入系统</a>";
    exit;
}

$db = new PDO('sqlite:' . $db_file);
$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

$admin_hash = password_hash('admin', PASSWORD_DEFAULT);

$db->exec("
PRAGMA foreign_keys = ON;

CREATE TABLE IF NOT EXISTS accounting_systems (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    description TEXT
);

CREATE TABLE IF NOT EXISTS books (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    start_year INTEGER,
    start_month INTEGER,
    system_id INTEGER NOT NULL,
    FOREIGN KEY(system_id) REFERENCES accounting_systems(id)
);

CREATE TABLE IF NOT EXISTS standard_accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    system_id INTEGER NOT NULL,
    code TEXT NOT NULL,
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    direction TEXT NOT NULL,
    parent_code TEXT,
    UNIQUE(system_id, code),
    FOREIGN KEY(system_id) REFERENCES accounting_systems(id)
);

CREATE TABLE IF NOT EXISTS accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    book_id INTEGER NOT NULL,
    code TEXT NOT NULL,
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    direction TEXT NOT NULL,
    parent_code TEXT,
    is_custom INTEGER DEFAULT 0,
    UNIQUE(book_id, code),
    FOREIGN KEY(book_id) REFERENCES books(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL,
    role TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS vouchers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    book_id INTEGER NOT NULL,
    number INTEGER,
    date TEXT NOT NULL,
    description TEXT,
    creator TEXT,
    created_at TEXT,
    updated_at TEXT,
    FOREIGN KEY(book_id) REFERENCES books(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS voucher_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    voucher_id INTEGER NOT NULL,
    summary TEXT,
    account_code TEXT NOT NULL,
    debit REAL DEFAULT 0,
    credit REAL DEFAULT 0,
    FOREIGN KEY(voucher_id) REFERENCES vouchers(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS balances (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    book_id INTEGER NOT NULL,
    account_code TEXT NOT NULL,
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    amount REAL DEFAULT 0,
    FOREIGN KEY(book_id) REFERENCES books(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS closings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    book_id INTEGER NOT NULL,
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    closed_at TEXT NOT NULL,
    user_id INTEGER,
    FOREIGN KEY(book_id) REFERENCES books(id) ON DELETE CASCADE
);
");

// 初始化会计制度
$db->exec("
INSERT INTO accounting_systems (code, name, description) VALUES
('xiaoqiye2013', '小企业会计准则2013', '适用于小微企业');
");

// 内置标准科目表（小企业会计准则2013），带parent_code
$system_id = 1;
$standard_accounts = [
    // code, name, category, direction, parent_code
     ['1001','库存现金','资产','借',null],
    ['1002','银行存款','资产','借',null],
    ['1012','其他货币资金','资产','借',null],
    ['1101','短期投资','资产','借',null],
    ['1121','应收票据','资产','借',null],
    ['1122','应收账款','资产','借',null],
    ['1123','预付账款','资产','借',null],
    ['1131','应收股利','资产','借',null],
    ['1132','应收利息','资产','借',null],
    ['1221','其他应收款','资产','借',null],
    ['122101','其他应收款-代扣代交个人养老保险费','资产','借','1221'],
    ['122102','其他应收款-代扣代交个人失业保险费','资产','借','1221'],
    ['122103','其他应收款-代扣代交个人医疗保险费','资产','借','1221'],
    ['1401','材料采购','资产','借',null],
    ['1402','在途物资','资产','借',null],
    ['1403','原材料','资产','借',null],
    ['1404','材料成本差异','资产','借',null],
    ['1405','库存商品','资产','借',null],
    ['1406','发出商品','资产','借',null],
    ['1407','商品进销差价','资产','借',null],
    ['1408','委托加工物资','资产','借',null],
    ['1409','半成品','资产','借',null],
    ['1411','周转材料','资产','借',null],
    ['1421','消耗性生物资产','资产','借',null],
    ['1501','长期债券投资','资产','借',null],
    ['1511','长期股权投资','资产','借',null],
    ['1601','固定资产','资产','借',null],
    ['1602','累计折旧','资产','贷',null],
    ['1604','在建工程','资产','借',null],
    ['1605','工程物资','资产','借',null],
    ['1606','固定资产清理','资产','借',null],
    ['1621','生产性生物资产','资产','借',null],
    ['1622','生产性生物资产累计折旧','资产','贷',null],
    ['1701','无形资产','资产','借',null],
    ['1702','累计摊销','资产','贷',null],
    ['1801','长期待摊费用','资产','借',null],
    ['1901','待处理财产损溢','资产','借',null],
    ['2001','短期借款','负债','贷',null],
    ['2201','应付票据','负债','贷',null],
    ['2202','应付账款','负债','贷',null],
    ['2203','预收账款','负债','贷',null],
    ['2211','应付职工薪酬','负债','贷',null],
    ['221101','应付职工薪酬-职工工资','负债','贷','2211'],
    ['221102','应付职工薪酬-奖金、津贴和补贴','负债','贷','2211'],
    ['221103','应付职工薪酬-职工福利费','负债','贷','2211'],
    ['221104','应付职工薪酬-社会保险费','负债','贷','2211'],
    ['22110401','应付职工薪酬-社会保险费-基本养老保险','负债','贷','221104'],
    ['22110402','应付职工薪酬-社会保险费-基本医疗保险','负债','贷','221104'],
    ['22110403','应付职工薪酬-社会保险费-工伤保险','负债','贷','221104'],
    ['22110404','应付职工薪酬-社会保险费-失业保险','负债','贷','221104'],
    ['22110405','应付职工薪酬-社会保险费-生育保险','负债','贷','221104'],
    ['221105','应付职工薪酬-住房公积金','负债','贷','2211'],
    ['221106','应付职工薪酬-工会经费','负债','贷','2211'],
    ['221107','应付职工薪酬-职工教育经费','负债','贷','2211'],
    ['2221','应交税费','负债','贷',null],
    ['222101','应交税费-应交增值税','负债','贷','2221'],
    ['22210101','应交税费-应交增值税-进项税额','负债','借','222101'],
    ['22210102','应交税费-应交增值税-已交税金','负债','借','222101'],
    ['22210103','应交税费-应交增值税-转出未交增值税','负债','借','222101'],
    ['22210104','应交税费-应交增值税-减免税款','负债','借','222101'],
    ['22210105','应交税费-应交增值税-销项税额','负债','贷','222101'],
    ['22210106','应交税费-应交增值税-出口退税','负债','贷','222101'],
    ['22210107','应交税费-应交增值税-出口抵减内销产品应纳税额','负债','借','222101'],
    ['22210108','应交税费-应交增值税-转出多交增值税','负债','贷','222101'],
    ['22210109','应交税费-应交增值税-进项税额转出','负债','贷','222101'],
    ['22210110','应交税费-应交增值税-销项税额抵减','负债','借','222101'],
    ['22210111','应交税费-应交增值税-小规模增值税','负债','贷','222101'],
    ['22210112','应交税费-应交增值税-增值税检查调整','负债','贷','222101'],
    ['222102','应交税费-未交增值税','负债','贷','2221'],
    ['222103','应交税费-应交所得税','负债','贷','2221'],
    ['222104','应交税费-应交印花税','负债','贷','2221'],
    ['222105','应交税费-应交营业税','负债','贷','2221'],
    ['222106','应交税费-应交消费税','负债','贷','2221'],
    ['222107','应交税费-应交城市维护建设税','负债','贷','2221'],
    ['222108','应交税费-应交个人所得税','负债','贷','2221'],
    ['222109','应交税费-应交教育费附加','负债','贷','2221'],
    ['222110','应交税费-应交地方教育费附加','负债','贷','2221'],
    ['222111','应交税费-应交水利基金/堤围费/河维费','负债','贷','2221'],
    ['222112','应交税费-待抵扣进项税额','负债','借','2221'],
    ['222120','应交税费-文化事业建设费','负债','贷','2221'],
    ['222121','应交税费-应交残疾人就业保障金','负债','贷','2221'],
    ['222122','应交税费-预交增值税','负债','借','2221'],
    ['222123','应交税费-简易计税','负债','贷','2221'],
    ['222124','应交税费-待认证进项税额','负债','借','2221'],
    ['222125','应交税费-待转销项税额','负债','贷','2221'],
    ['222126','应交税费-增值税留抵税额','负债','借','2221'],
    ['222127','应交税费-转让金融商品应交增值税','负债','贷','2221'],
    ['222128','应交税费-代扣代交增值税','负债','贷','2221'],
    ['2231','应付利息','负债','贷',null],
    ['2232','应付利润','负债','贷',null],
    ['2241','其他应付款','负债','贷',null],
    ['2401','递延收益','负债','贷',null],
    ['2501','长期借款','负债','贷',null],
    ['2701','长期应付款','负债','贷',null],
    ['2809','执业风险基金','负债','贷',null],
    ['3001','实收资本','所有者权益','贷',null],
    ['3002','资本公积','所有者权益','贷',null],
    ['3101','盈余公积','所有者权益','贷',null],
    ['3103','本年利润','所有者权益','贷',null],
    ['3104','利润分配','所有者权益','贷',null],
    ['310401','利润分配-未分配利润','所有者权益','贷','3104'],
    ['310402','利润分配-应付利润','所有者权益','贷','3104'],
    ['310403','利润分配-以前年度损益调整','所有者权益','贷','3104'],
    ['4001','生产成本','成本','借',null],
    ['400101','生产成本-直接材料','成本','借','4001'],
    ['400102','生产成本-直接人工','成本','借','4001'],
    ['400103','生产成本-燃料和动力','成本','借','4001'],
    ['400104','生产成本-折旧费用','成本','借','4001'],
    ['400105','生产成本-制造费用','成本','借','4001'],
    ['400106','生产成本-大修理费','成本','借','4001'],
    ['400107','生产成本-职工福利费','成本','借','4001'],
    ['400108','生产成本-职工教育经费','成本','借','4001'],
    ['400109','生产成本-社会保险费','成本','借','4001'],
    ['400110','生产成本-住房公积金','成本','借','4001'],
    ['4002','劳务成本','成本','借',null],
    ['4101','制造费用','成本','借',null],
    ['410101','制造费用-工资薪酬','成本','借','4101'],
    ['410102','制造费用-燃料动力','成本','借','4101'],
    ['410103','制造费用-折旧费用','成本','借','4101'],
    ['410104','制造费用-职工福利费','成本','借','4101'],
    ['410105','制造费用-职工教育经费','成本','借','4101'],
    ['410106','制造费用-社会保险费','成本','借','4101'],
    ['410107','制造费用-住房公积金','成本','借','4101'],
    ['4301','研发支出','成本','借',null],
    ['4401','工程施工','成本','借',null],
    ['4403','机械作业','成本','借',null],
    ['5001','主营业务收入','损益','贷',null],
    ['500101','主营业务收入-货物收入','损益','贷','5001'],
    ['500102','主营业务收入-劳务收入','损益','贷','5001'],
    ['500103','主营业务收入-服务收入','损益','贷','5001'],
    ['5051','其他业务收入','损益','贷',null],
    ['505101','其他业务收入-货物收入','损益','贷','5051'],
    ['505102','其他业务收入-劳务收入','损益','贷','5051'],
    ['505103','其他业务收入-服务收入','损益','贷','5051'],
    ['5111','投资收益','损益','贷',null],
    ['5301','营业外收入','损益','贷',null],
    ['530101','营业外收入-政府补助','损益','贷','5301'],
    ['530102','营业外收入-捐赠收益','损益','贷','5301'],
    ['530103','营业外收入-非流动资产处置净收益','损益','贷','5301'],
    ['530104','营业外收入-盘盈收益','损益','贷','5301'],
    ['530105','营业外收入-汇兑收益','损益','贷','5301'],
    ['5401','主营业务成本','损益','借',null],
    ['5402','其他业务成本','损益','借',null],
    ['5403','税金及附加','损益','借',null],
    ['540301','税金及附加-消费税','损益','借','5403'],
    ['540302','税金及附加-营业税','损益','借','5403'],
    ['540303','税金及附加-城市维护建设税','损益','借','5403'],
    ['540304','税金及附加-印花税','损益','借','5403'],
    ['540305','税金及附加-教育费附加','损益','借','5403'],
    ['540306','税金及附加-地方教育费附加','损益','借','5403'],
    ['540307','税金及附加-水利基金/堤围费/河维费','损益','借','5403'],
    ['540308','税金及附加-资源税','损益','借','5403'],
    ['540309','税金及附加-土地增值税','损益','借','5403'],
    ['540310','税金及附加-城镇土地使用税','损益','借','5403'],
    ['540311','税金及附加-房产税','损益','借','5403'],
    ['540312','税金及附加-车船税','损益','借','5403'],
    ['540313','税金及附加-矿产资源补偿费','损益','借','5403'],
    ['540314','税金及附加-排污费','损益','借','5403'],
    ['540315','税金及附加-文化事业建设费','损益','借','5403'],
    ['5601','销售费用','损益','借',null],
    ['560101','销售费用-运输费','损益','借','5601'],
    ['560102','销售费用-装卸费','损益','借','5601'],
    ['560103','销售费用-包装费','损益','借','5601'],
    ['560104','销售费用-广告费和业务宣传费','损益','借','5601'],
    ['560105','销售费用-展览费','损益','借','5601'],
    ['560106','销售费用-仓储费','损益','借','5601'],
    ['560107','销售费用-业务招待费','损益','借','5601'],
    ['560108','销售费用-差旅费','损益','借','5601'],
    ['560109','销售费用-办公费','损益','借','5601'],
    ['560110','销售费用-报关费','损益','借','5601'],
    ['560111','销售费用-单证费','损益','借','5601'],
    ['560112','销售费用-国际快递费','损益','借','5601'],
    ['560113','销售费用-商品维修费','损益','借','5601'],
    ['560114','销售费用-社会保险费','损益','借','5601'],
    ['560115','销售费用-职工薪酬','损益','借','5601'],
    ['560116','销售费用-职工福利费','损益','借','5601'],
    ['560117','销售费用-职工教育经费','损益','借','5601'],
    ['560118','销售费用-住房公积金','损益','借','5601'],
    ['560119','销售费用-各项税费','损益','借','5601'],
    ['5602','管理费用','损益','借',null],
    ['560201','管理费用-折旧费','损益','借','5602'],
    ['560202','管理费用-修理费','损益','借','5602'],
    ['560203','管理费用-办公费','损益','借','5602'],
    ['560204','管理费用-水电费','损益','借','5602'],
    ['560205','管理费用-差旅费','损益','借','5602'],
    ['560206','管理费用-房租','损益','借','5602'],
    ['560207','管理费用-业务招待费','损益','借','5602'],
    ['560208','管理费用-车辆使用费','损益','借','5602'],
    ['560209','管理费用-职工薪酬','损益','借','5602'],
    ['560210','管理费用-社会保险费','损益','借','5602'],
    ['560211','管理费用-职工福利费','损益','借','5602'],
    ['560212','管理费用-职工教育经费','损益','借','5602'],
    ['560213','管理费用-住房公积金','损益','借','5602'],
    ['560214','管理费用-各项税费','损益','借','5602'],
    ['560215','管理费用-工会经费','损益','借','5602'],
    ['560216','管理费用-聘请中介机构费','损益','借','5602'],
    ['560217','管理费用-咨询顾问费','损益','借','5602'],
    ['560218','管理费用-开办费','损益','借','5602'],
    ['560219','管理费用-研究费用','损益','借','5602'],
    ['560220','管理费用-广告费和业务宣传费','损益','借','5602'],
    ['5603','财务费用','损益','借',null],
    ['560301','财务费用-利息费用','损益','借','5603'],
    ['560302','财务费用-手续费','损益','借','5603'],
    ['560303','财务费用-汇兑损失','损益','借','5603'],
    ['560304','财务费用-现金折扣','损益','借','5603'],
    ['5711','营业外支出','损益','借',null],
    ['571101','营业外支出-税收滞纳金、罚金、罚款','损益','借','5711'],
    ['571102','营业外支出-坏账损失','损益','借','5711'],
    ['571103','营业外支出-无法收回的长期债券投资损失','损益','借','5711'],
    ['571104','营业外支出-无法收回的长期股权投资损失','损益','借','5711'],
    ['571105','营业外支出-自然灾害等不可抗力因素造成的损失','损益','借','5711'],
    ['5801','所得税费用','损益','借',null],
];

//settings设置页面
$db->exec("
CREATE TABLE IF NOT EXISTS settings (
    k TEXT PRIMARY KEY,
    v TEXT
);
");

$stmt = $db->prepare("INSERT INTO standard_accounts (system_id, code, name, category, direction, parent_code) VALUES (?, ?, ?, ?, ?, ?)");
foreach ($standard_accounts as $a) {
    $stmt->execute([$system_id, $a[0], $a[1], $a[2], $a[3], $a[4]]);
}

// 创建第一个账套，绑定小企业会计准则
$stmt = $db->prepare("INSERT INTO books (name, start_year, start_month, system_id) VALUES (?, ?, ?, ?)");
$stmt->execute(['默认账套', date('Y'), date('n'), $system_id]);
$book_id = $db->lastInsertId();

// 从标准科目表复制一份到账套科目表
$stmt = $db->prepare("SELECT code, name, category, direction, parent_code FROM standard_accounts WHERE system_id=?");
$stmt->execute([$system_id]);
$accounts = $stmt->fetchAll(PDO::FETCH_ASSOC);
$stmt2 = $db->prepare("INSERT INTO accounts (book_id, code, name, category, direction, parent_code, is_custom) VALUES (?, ?, ?, ?, ?, ?, 0)");
foreach ($accounts as $a) {
    $stmt2->execute([$book_id, $a['code'], $a['name'], $a['category'], $a['direction'], $a['parent_code']]);
}

// 创建管理员用户
$stmt = $db->prepare("INSERT INTO users (username, password, role) VALUES (?, ?, ?)");
$stmt->execute(['admin', $admin_hash, '超级管理员']);

echo "<h3>数据库初始化完成！（支持多制度、多账套、账套科目个性化，标准科目内置完整）</h3>";
echo "<p>管理员账号：admin，初始密码：admin</p>";
echo "<a href='books_add.php'>创建账套</a>";
?>